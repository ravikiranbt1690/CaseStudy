/**
 * Local Mock API Data
*/
let employees = [
		{
			"id": 1,
			"jobTitleName": "Developer",
			"firstName": "Romin",
			"lastName": "Irani",
			"preferredFullName": "Romin Irani",
			"employeeCode": "E1",
			"region": "CA",
			"dob": "01/10/1993",
			"phoneNumber": "408-1234567",
			"emailAddress": "romin.k.irani@gmail.com"
		},
		{
			"id": 2,
			"jobTitleName": "Developer",
			"firstName": "Neil",
			"lastName": "Irani",
			"preferredFullName": "Neil Irani",
			"employeeCode": "E2",
			"region": "CA",
			"dob": "01/10/1992",
			"phoneNumber": "408-1111111",
			"emailAddress": "neilrirani@gmail.com"
		},
		{
			"id": 3,
			"jobTitleName": "Program Directory",
			"firstName": "Tom",
			"lastName": "Hanks",
			"dob": "05/12/1995",
			"preferredFullName": "Tom Hanks",
			"employeeCode": "E3",
			"region": "CA",
			"phoneNumber": "408-2222222",
			"emailAddress": "tomhanks@gmail.com"
		},
		{
			"id": 4,
			"jobTitleName": "Developer",
			"firstName": "Romin",
			"lastName": "Irani",
			"preferredFullName": "Romin Irani",
			"employeeCode": "E1",
			"region": "CA",
			"dob": "01/10/1993",
			"phoneNumber": "408-1234567",
			"emailAddress": "romin.k.irani@gmail.com"
		},
		{
			"id": 5,
			"jobTitleName": "Developer",
			"firstName": "Neil",
			"lastName": "Irani",
			"preferredFullName": "Neil Irani",
			"employeeCode": "E2",
			"region": "CA",
			"dob": "01/10/1992",
			"phoneNumber": "408-1111111",
			"emailAddress": "neilrirani@gmail.com"
		},
		{
			"id": 6,
			"jobTitleName": "Program Directory",
			"firstName": "Tom",
			"lastName": "Hanks",
			"dob": "05/12/1995",
			"preferredFullName": "Tom Hanks",
			"employeeCode": "E3",
			"region": "CA",
			"phoneNumber": "408-2222222",
			"emailAddress": "tomhanks@gmail.com"
		},
		{
			"id": 7,
			"jobTitleName": "Developer",
			"firstName": "Romin",
			"lastName": "Irani",
			"preferredFullName": "Romin Irani",
			"employeeCode": "E1",
			"region": "CA",
			"dob": "01/10/1993",
			"phoneNumber": "408-1234567",
			"emailAddress": "romin.k.irani@gmail.com"
		},
		{
			"id": 8,
			"jobTitleName": "Developer",
			"firstName": "Neil",
			"lastName": "Irani",
			"preferredFullName": "Neil Irani",
			"employeeCode": "E2",
			"region": "CA",
			"dob": "01/10/1992",
			"phoneNumber": "408-1111111",
			"emailAddress": "neilrirani@gmail.com"
		},
		{
			"id": 9,
			"jobTitleName": "Program Directory",
			"firstName": "Tom",
			"lastName": "Hanks",
			"dob": "05/12/1995",
			"preferredFullName": "Tom Hanks",
			"employeeCode": "E3",
			"region": "CA",
			"phoneNumber": "408-2222222",
			"emailAddress": "tomhanks@gmail.com"
		},
		{
			"id": 10,
			"jobTitleName": "Developer",
			"firstName": "Romin",
			"lastName": "Irani",
			"preferredFullName": "Romin Irani",
			"employeeCode": "E1",
			"region": "CA",
			"dob": "01/10/1993",
			"phoneNumber": "408-1234567",
			"emailAddress": "romin.k.irani@gmail.com"
		},
		{
			"id": 11,
			"jobTitleName": "Developer",
			"firstName": "Neil",
			"lastName": "Irani",
			"preferredFullName": "Neil Irani",
			"employeeCode": "E2",
			"region": "CA",
			"dob": "01/10/1992",
			"phoneNumber": "408-1111111",
			"emailAddress": "neilrirani@gmail.com"
		},
		{
			"id": 12,
			"jobTitleName": "Program Directory",
			"firstName": "Tom",
			"lastName": "Hanks",
			"dob": "05/12/1995",
			"preferredFullName": "Tom Hanks",
			"employeeCode": "E3",
			"region": "CA",
			"phoneNumber": "408-2222222",
			"emailAddress": "tomhanks@gmail.com"
		},
		{
			"id": 13,
			"jobTitleName": "Developer",
			"firstName": "Romin",
			"lastName": "Irani",
			"preferredFullName": "Romin Irani",
			"employeeCode": "E1",
			"region": "CA",
			"dob": "01/10/1993",
			"phoneNumber": "408-1234567",
			"emailAddress": "romin.k.irani@gmail.com"
		},
		{
			"id": 14,
			"jobTitleName": "Developer",
			"firstName": "Neil",
			"lastName": "Irani",
			"preferredFullName": "Neil Irani",
			"employeeCode": "E2",
			"region": "CA",
			"dob": "01/10/1992",
			"phoneNumber": "408-1111111",
			"emailAddress": "neilrirani@gmail.com"
		},
		{
			"id": 15,
			"jobTitleName": "Program Directory",
			"firstName": "Tom",
			"lastName": "Hanks",
			"dob": "05/12/1995",
			"preferredFullName": "Tom Hanks",
			"employeeCode": "E3",
			"region": "CA",
			"phoneNumber": "408-2222222",
			"emailAddress": "tomhanks@gmail.com"
		},
		{
			"id": 16,
			"jobTitleName": "Developer",
			"firstName": "Romin",
			"lastName": "Irani",
			"preferredFullName": "Romin Irani",
			"employeeCode": "E1",
			"region": "CA",
			"dob": "01/10/1993",
			"phoneNumber": "408-1234567",
			"emailAddress": "romin.k.irani@gmail.com"
		},
		{
			"id": 17,
			"jobTitleName": "Developer",
			"firstName": "Neil",
			"lastName": "Irani",
			"preferredFullName": "Neil Irani",
			"employeeCode": "E2",
			"region": "CA",
			"dob": "01/10/1992",
			"phoneNumber": "408-1111111",
			"emailAddress": "neilrirani@gmail.com"
		},
		{
			"id": 18,
			"jobTitleName": "Program Directory",
			"firstName": "Tom",
			"lastName": "Hanks",
			"dob": "05/12/1995",
			"preferredFullName": "Tom Hanks",
			"employeeCode": "E3",
			"region": "CA",
			"phoneNumber": "408-2222222",
			"emailAddress": "tomhanks@gmail.com"
		},
		{
			"id": 19,
			"jobTitleName": "Developer",
			"firstName": "Romin",
			"lastName": "Irani",
			"preferredFullName": "Romin Irani",
			"employeeCode": "E1",
			"region": "CA",
			"dob": "01/10/1993",
			"phoneNumber": "408-1234567",
			"emailAddress": "romin.k.irani@gmail.com"
		},
		{
			"id": 20,
			"jobTitleName": "Developer",
			"firstName": "Neil",
			"lastName": "Irani",
			"preferredFullName": "Neil Irani",
			"employeeCode": "E2",
			"region": "CA",
			"dob": "01/10/1992",
			"phoneNumber": "408-1111111",
			"emailAddress": "neilrirani@gmail.com"
		},
		{
			"id": 21,
			"jobTitleName": "Program Directory",
			"firstName": "Tom",
			"lastName": "Hanks",
			"dob": "05/12/1995",
			"preferredFullName": "Tom Hanks",
			"employeeCode": "E3",
			"region": "CA",
			"phoneNumber": "408-2222222",
			"emailAddress": "tomhanks@gmail.com"
		}
];

/**
 * Merge Sort Algorithm
*/
let mergeSort = (() => {

	function swap(items, i, j) {
		let t = items[i];
		items[i] = items[j];
		items[j] = t;
	}

	function sortHelper(items, comparator, start, end) {
		if (start >= end) return;
		let lt = start, i = start, gt = end;
		while (i <= gt) {
			let cmp = comparator(items[i], items[lt]);
			if (cmp < 0) swap(items, i++, lt++);
			else if (cmp > 0) swap(items, i, gt--);
			else i++;
		}
		sortHelper(items, comparator, start, lt - 1);
		sortHelper(items, comparator, gt + 1, end);
	}

	function sort(items, comparator) {
		sortHelper(items, comparator, 0, items.length - 1);
	}

	return {
		sort: sort
	}
})();

/**
 * We have Created Counter Class to generate new Id for each Employee when created
*/
let Counter = (() => {
	class Counter {
		constructor(count) {
			this.count = count;
		}
		increment() {
			return ++this.count;
		}
	}

	return {
		Counter: Counter
	}
})();

/**
 * We have Created a Anonymous Function for Employee Servicev which has its own Ulitity Functions
*/

let EmployeeService = (function() {

	function compareStrings(a, b) {
		return a.toLowerCase().localeCompare(b.toLowerCase());
	}

	function compareDates(a, b) {
		var splitA = a.split("/");
		var splitB = b.split("/");
		if (splitA[2] !== splitB[2]) return splitA[2] - splitB[2];
		if (splitA[1] !== splitB[1]) return splitA[1] - splitB[1];
		if (splitA[0] !== splitB[0]) return splitA[0] - splitB[0];
	}
	
	function comparePhoneNumbers(a, b) {}

	function compareEmails(a, b) {}

	let comparators = {
		id: function(a, b) {
			return (a["id"] - b["id"]);
		},
		jobTitleName: function(a, b) {
			return compareStrings(a['jobTitleName'], b['jobTitleName']);
		},
		firstName: function(a, b) {
			return compareStrings(a['firstName'], b['firstName']);
		},
		lastName: function(a, b) {
			return compareStrings(a['lastName'], b['lastName']);
		},
		preferredFullName: function(a, b) {
			return compareStrings(a['preferredFullName'], b['preferredFullName']);
		},
		employeeCode: function(a, b) {
			return compareStrings(a['employeeCode'], b['employeeCode']);
		},
		region: function(a, b) {
			return compareStrings(a['region'], b['region']);
		},
		dob: function(a, b) {
			return compareDates(a['dob'], b['dob']);
		},
		phoneNumber: function(a, b) {
			return comparePhoneNumbers(a['phoneNumber'], b['phoneNumber']);
		},
		emailAddress: function(a, b) {
			return compareEmails(a['emailAddress'], b['emailAddress']);
		}
	};

	function reverseComparator(comparator) {
		return function(a, b) {
			return comparator(b, a);
		}
	}

	let idGenerator = new Counter.Counter(employees.length);

	function filterBasedOnSearch(items, query, key) {
		return items.filter((item) => {
			return (item[key].toString().toLowerCase().indexOf(query.toLowerCase()) >= 0);
		});
	}

	function filterBasedOnPagination(items, pageNumber, entriesPerPage) {
		let startIdx = pageNumber * entriesPerPage;
		if (startIdx >= items.length) return [];
		let endIdx = pageNumber * entriesPerPage + entriesPerPage;
		return items.slice(startIdx, endIdx);
	}

	function validateEmployee(employee) {
		return true;
	}

	/**
	 * CRUD OPERATIONS ON DATATABLE. All the operations are carried out on the local data
		to mock the behaviour of client-server communication. 
		We do trigger API Request from 
		Datatable Component which triggers the service here.
	*/

	/** 
	 * Fetch Particular Employees based on the Request Payload Received. 
	*/

	function fetchEmployees(request) {
		return new Promise(function(resolve, reject) {
			try {
				let {search, sort, pagination} = request.filters;

				let result = employees;

				// filter based on search query
				if (comparators.hasOwnProperty(search.key))
				result = filterBasedOnSearch(employees, search.query, search.key);

				let totalLength = result.length;

				// sort the list
				if (comparators.hasOwnProperty(sort.key)) {
					let comparator;
					if (sort.order == 'dec') {
						comparator = reverseComparator(comparators[sort.key]);
					} else {
						comparator = comparators[sort.key];
					}
					mergeSort.sort(result, comparator);
				}

				// filter according to pages
				result = filterBasedOnPagination(result, pagination.pageNumber, pagination.entriesPerPage);

				// send a successful response
				resolve({
					data: {
						totalLength: totalLength,
						employees: JSON.parse(JSON.stringify(result))
					}
				});

			} catch (err) {
				reject({
					error: err
				});
			}
		});
	}

	/** 
	 * Adds a Individual Employee. 
	 *  @param {Object} request Request Payload to Create the Employee.
	 * 	@example {
        "jobTitleName": "Developer",
        "firstName": "Neil",
        "lastName": "Irani",
        "preferredFullName": "Neil Irani",
        "employeeCode": "E2",
        "region": "CA",
        "dob": '01/10/1992',
        "phoneNumber": "408-1111111",
        "emailAddress": "neilrirani@gmail.com"
			}
		*	
	*/

	function addEmployee(request) {
		return new Promise(function(resolve, reject) {
			try {
				let {employee} = request;
				if (!validateEmployee(employee)) {
					reject({
						error: "Invalid employee"
					});
					return;
				}
				employee.id = idGenerator.increment();
				employee.employeeCode = "E" + employee.id;

				employees.push(employee);
				resolve({
					msg: "success"
				});
			} catch(err) {
				reject({
					error: err
				});
			}
		});
	}

	/**
	 * Deletes Specific Employee
	 * @param {Object} request 
	*/

	function deleteEmployee(request) {
		return new Promise(function(resolve, reject) {
			try {
				let idx = -1;
				let { id } = request;
				for (let i = 0 ; i < employees.length ; i++) {
					if (employees[i].id == id) {
						idx = i;
						break;
					}
				}
				if (idx >= 0) {
					employees.splice(idx, 1);
					resolve({
						msg: "success"
					});
				} else {
					reject({
						error: "Employee does not exist"
					});
				}
			} catch (err) {
				reject({
					error: err
				});
			}
		});
	}

	/** 
	 * Updates a Specific Employee. 
	 *  @param {Object} request Request Payload to Create the Employee.
	 * 	@example {
        "jobTitleName": "Developer",
        "firstName": "Neil",
        "lastName": "Irani",
        "preferredFullName": "Neil Irani",
        "employeeCode": "E2",
        "region": "CA",
        "dob": '01/10/1992',
        "phoneNumber": "408-1111111",
        "emailAddress": "neilrirani@gmail.com"
			}
		*	
	*/

	function updateEmployee(request) {
		return new Promise(function(resolve, reject) {
			try {
				let idx = -1;
				let {employee, id} = request;
				if (!validateEmployee(employee)) {
					reject({
						error: "Invalid employee"
					});
					return;
				}
				for (let i = 0 ; i < employees.length ; i++) {
					if (employees[i].id == id) {
						idx = i;
						break;
					}
				}
				if (idx >= 0) {
					for (let key in employee) {
						if (employee.hasOwnProperty(key) && employees[idx].hasOwnProperty(key)) {
							employees[idx][key] = employee[key];
						}
					}
					resolve({
						msg: "success"
					});
				} else {
					reject({
						error: "Employee does not exist"
					});
				}
			} catch (err) {
				reject({
					error: err
				});
			}
		});
	}

	/**
	 * Fetch and Read a Specific Employee
	 * @param {Object} request 
	*/

	function fetchEmployee(request) {
		return new Promise(function(resolve, reject) {
			try {
				let idx = -1;
				let { id } = request;
				for (let i = 0 ; i < employees.length ; i++) {
					if (employees[i].id == id) {
						idx = i;
						break;
					}
				}
				if (idx >= 0) {
					resolve({
						data: JSON.parse(JSON.stringify(employees[idx]))
					});
				} else {
					reject({
						error: "Employee does not exist"
					});
				}
			} catch (err) {
				reject(err);
			}
		});
	}
	
	return {
		fetchEmployees : fetchEmployees,
		addEmployee    : addEmployee,
		deleteEmployee : deleteEmployee,
		updateEmployee : updateEmployee,
		fetchEmployee  : fetchEmployee
	}

})();
